---
import { ISbResult, ISbStoryData, useStoryblokApi } from "@storyblok/astro";
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import {
  HeaderStoryblok,
  PageStoryblok,
} from "../generated/component-types-sb";
import BaseLayout from "../layouts/BaseLayout.astro";
import Page from "../storyblok/Page.astro";

export async function getStaticPaths() {
  const storyblokApi = useStoryblokApi();

  const { data } = await storyblokApi.get("cdn/links", {
    version: "draft",
  });

  let links = data.links;
  links = Object.values(links);

  const paths = links.map((link) => {
    return {
      params: { path: link.slug },
    };
  });

  paths.push({ params: { path: undefined } });

  return paths;
}

let { path } = Astro.params;

path = path == undefined ? "home" : path;

const storyblokApi = useStoryblokApi();

const { data: headerData } = await storyblokApi.get(`cdn/stories/header`, {
  version: import.meta.env.PUBLIC_STORYBLOK_API_VERSION,
});

const { data } = await storyblokApi.get(`cdn/stories/${path}`, {
  version: import.meta.env.PUBLIC_STORYBLOK_API_VERSION,
});

const story: ISbStoryData<PageStoryblok> = data.story;
const header: ISbStoryData<HeaderStoryblok> = headerData.story;
---

<BaseLayout>
  <StoryblokComponent
    blok={story.content}
    headerBlok={header.content}
    path={path}
  />
</BaseLayout>
